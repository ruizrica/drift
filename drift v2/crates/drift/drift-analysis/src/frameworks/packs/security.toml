[framework]
name = "security-patterns"
display_name = "Security Patterns"
languages = ["typescript", "javascript", "python", "java", "csharp", "go", "rust", "ruby", "php", "kotlin", "cpp", "c", "swift", "scala"]

# --- CSRF Protection ---

[[patterns]]
id = "SEC-CSRF-TOKEN-001"
category = "security"
description = "CSRF token usage"
sub_type = "csrf"
confidence = 0.85
cwe_ids = [352]
owasp = "A01:2021"
[patterns.match]
content_patterns = [
    "(?i)csrf[_-]?token",
    "(?i)xsrf[_-]?token",
    "(?i)anti[_-]csrf",
    "(?i)generate[_-]?csrf",
    "(?i)validate[_-]?csrf",
    "(?i)verify[_-]?csrf",
    "(?i)CsrfViewMiddleware",
    "(?i)csrf_protect",
]

[[patterns]]
id = "SEC-CSRF-MIDDLEWARE-001"
category = "security"
description = "CSRF middleware usage"
sub_type = "csrf"
confidence = 0.90
cwe_ids = [352]
[patterns.match]
imports = ["csurf", "csrf", "lusca"]

[[patterns]]
id = "SEC-CSRF-SAMESITE-001"
category = "security"
description = "SameSite cookie configuration"
sub_type = "csrf"
confidence = 0.85
[patterns.match]
content_patterns = ["(?i)sameSite\\s*[=:]\\s*['\"`](?:strict|lax|none)"]

# --- SQL Injection ---

[[patterns]]
id = "SEC-SQLI-RAW-001"
category = "security"
description = "Raw SQL query construction (potential injection)"
sub_type = "sql-injection"
confidence = 0.70
cwe_ids = [89]
owasp = "A03:2021"
[patterns.match]
content_patterns = [
    "(?i)\\$\\{.*\\}.*(?:SELECT|INSERT|UPDATE|DELETE|FROM|WHERE)",
    "(?i)f['\"].*(?:SELECT|INSERT|UPDATE|DELETE|FROM|WHERE)",
    "(?i)\\+\\s*['\"]\\s*(?:SELECT|INSERT|UPDATE|DELETE|FROM|WHERE)",
    "(?i)format!.*(?:SELECT|INSERT|UPDATE|DELETE|FROM|WHERE)",
]

[[patterns]]
id = "SEC-SQLI-PARAM-001"
category = "security"
description = "Parameterized query usage (safe pattern)"
sub_type = "sql-injection"
confidence = 0.90
[patterns.match]
content_patterns = [
    # JDBC/sqlite style: VALUES (?, ?, ?) or WHERE id = ?
    "(?i)\\?\\s*,\\s*\\[",
    # PostgreSQL positional params: $1, $2 â€” but only in SQL context
    "(?i)(?:SELECT|INSERT|UPDATE|DELETE|WHERE|SET|VALUES|FROM)\\s+.*\\$\\d+",
    # Python DB-API: %s with execute
    "(?i)%s.*execute",
    # Named params in SQL strings: require SQL keyword on the SAME line
    "(?i)(?:SELECT|INSERT|UPDATE|DELETE|WHERE|SET|VALUES|FROM)\\s+.*(?::param|:name|:id|:value|:user)",
]
[patterns.match.not]
content_patterns = [
    # Exclude Express/Hono/Fastify URL route definitions: app.get("/path/:id", ...)
    "(?i)(?:app|router|server|fastify)\\s*\\.\\s*(?:get|post|put|delete|patch|all|options|head)\\s*\\(\\s*['\"/]",
    # Exclude route path strings: "/api/v1/teams/:id" or '/users/:user_id'
    "(?i)['\"]\\s*/[\\w/]*:[\\w]+",
]

# --- XSS Prevention ---

[[patterns]]
id = "SEC-XSS-SANITIZE-001"
category = "security"
description = "XSS sanitization function"
sub_type = "xss"
confidence = 0.85
cwe_ids = [79]
owasp = "A03:2021"
[patterns.match]
calls = [
    "escapeHtml", "sanitizeHtml", "DOMPurify.sanitize",
    "bleach.clean", "html.escape", "cgi.escape",
    "HtmlEncoder.Encode", "AntiXssEncoder.HtmlEncode",
    "ERB::Util.html_escape", "h",
]

[[patterns]]
id = "SEC-XSS-DANGERHTML-001"
category = "security"
description = "Dangerous HTML injection"
sub_type = "xss"
confidence = 0.75
cwe_ids = [79]
[patterns.match]
content_patterns = [
    "(?i)dangerouslySetInnerHTML",
    "(?i)innerHTML\\s*=",
    "(?i)v-html\\s*=",
    "(?i)\\[innerHTML\\]",
    "(?i)\\{!!.*!!\\}",
    "(?i)mark_safe",
    "(?i)\\.html_safe",
]

# --- CSP Headers ---

[[patterns]]
id = "SEC-CSP-HEADER-001"
category = "security"
description = "Content Security Policy header"
sub_type = "csp"
confidence = 0.90
[patterns.match]
content_patterns = [
    "(?i)content-security-policy",
    "(?i)contentSecurityPolicy",
    "(?i)helmet\\.contentSecurityPolicy",
]

# --- Rate Limiting ---

[[patterns]]
id = "SEC-RATE-LIMIT-001"
category = "security"
description = "Rate limiting implementation"
sub_type = "rate-limiting"
confidence = 0.85
[patterns.match]
imports = [
    "express-rate-limit", "rate-limiter-flexible", "bottleneck",
    "slowapi", "django-ratelimit", "flask-limiter",
    "rack-attack", "rack-throttle",
    "throttle", "RateLimiter",
]

[[patterns]]
id = "SEC-RATE-LIMIT-CALL-001"
category = "security"
description = "Rate limiter function call"
sub_type = "rate-limiting"
confidence = 0.80
[patterns.match]
content_patterns = [
    "(?i)rateLimit\\s*\\(",
    "(?i)rate_limit\\s*\\(",
    "(?i)throttle\\s*\\(",
    "(?i)@ratelimit",
    "(?i)RateLimiter",
]

# --- Secret Management ---

[[patterns]]
id = "SEC-SECRET-VAULT-001"
category = "security"
description = "Secret management service usage"
sub_type = "secrets"
confidence = 0.90
[patterns.match]
imports = [
    "aws-sdk/client-secrets-manager", "@azure/keyvault-secrets",
    "@google-cloud/secret-manager", "hashicorp/vault",
    "hvac", "boto3",
]

# --- Input Sanitization ---

[[patterns]]
id = "SEC-INPUT-VALIDATE-001"
category = "security"
description = "Input validation library"
sub_type = "input-validation"
confidence = 0.85
[patterns.match]
imports = [
    "joi", "yup", "zod", "class-validator", "express-validator",
    "cerberus", "marshmallow", "pydantic",
    "FluentValidation", "DataAnnotations",
]

[[patterns]]
id = "SEC-INPUT-SANITIZE-001"
category = "security"
description = "Input sanitization call"
sub_type = "input-validation"
confidence = 0.80
[patterns.match]
content_patterns = [
    "(?i)sanitize\\s*\\(",
    "(?i)validate\\s*\\(",
    "(?i)validator\\.",
    "(?i)escape\\s*\\(",
    "(?i)strip_tags\\s*\\(",
    "(?i)htmlspecialchars\\s*\\(",
]
